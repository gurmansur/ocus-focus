<app-project-header
  (onBack)="navigateToKanban()"
  voltar="Voltar ao Kanban"
></app-project-header>

<div class="flex flex-col gap-4 my-3 mr-8">
  <!-- Sprint Selector -->
  @if (sprints.length > 1) {
    <div class="flex gap-2 items-center justify-end">
      <label for="sprintSelector" class="text-sm font-semibold">Sprint:</label>
      <select
        id="sprintSelector"
        [(ngModel)]="activeSprint"
        (change)="separateSprintsFromBacklog()"
        class="bg-slate-200 p-2 rounded-sm focus:ring-violet-400 focus:ring-2 focus:outline-none"
      >
        @for (sprint of sprints; track sprint.id) {
          <option [ngValue]="sprint">{{ sprint.nome }}</option>
        }
      </select>
    </div>
  }

  <!-- Action Buttons -->
  <div class="flex justify-end gap-2 md:gap-4">
    <app-button (onClick)="openConfigModal()">
      <app-gear-icon></app-gear-icon>
      Gerenciar Sprints
    </app-button>

    <app-button (onClick)="runSprint()">
      <app-sprint-icon></app-sprint-icon>
      Come√ßar Sprint
    </app-button>
  </div>
</div>

<div class="w-full max-w-6xl mx-auto px-6 md:px-8 font-sans" cdkDropListGroup>
  @if (sprints.length === 0) {
    <div class="text-center py-8">
      <p class="text-gray-500">Nenhuma sprint configurada para este projeto</p>
    </div>
  } @else {
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10">
      <!-- Backlog -->
      <div class="m-0">
        <div class="flex items-end justify-between mb-2">
          <div>
            <span class="font-semibold text-lg">Backlog</span> <br />
            <span class="text-xs text-gray-600"
              >{{ qtdTodo }} US / {{ timeTodo }} horas</span
            >
          </div>
        </div>
        <div
          id="backlogList"
          class="w-full bg-slate-100 flex flex-col min-h-[3rem] rounded-lg outline outline-1 outline-slate-200"
          cdkDropList
          #backlogList="cdkDropList"
          [cdkDropListData]="todo"
          [cdkDropListConnectedTo]="[sprintList]"
          (cdkDropListDropped)="drop($event)"
          role="list"
          aria-label="Lista de backlog"
        >
          @if (todo.length === 0) {
            <div class="text-xs text-gray-500 py-3 px-3">
              Sem itens no backlog
            </div>
          }
          @for (item of todo; track item.id) {
            <div
              class="card-tasks"
              cdkDrag
              [cdkDragData]="item"
              role="listitem"
              tabindex="0"
            >
              {{ item.titulo }}
            </div>
          }
        </div>
      </div>

      <!-- Sprint Ativo -->
      <div class="m-0">
        <div class="flex items-end justify-between mb-2">
          <div>
            <span class="font-semibold text-lg">{{
              activeSprint?.nome || "Sprint"
            }}</span>
            <br />
            <span class="text-xs text-gray-600"
              >{{ qtdDone }} US / {{ timeDone }} horas</span
            >
          </div>
        </div>
        <div
          id="sprintList"
          class="w-full bg-slate-100 flex flex-col min-h-[3rem] rounded-lg outline outline-1 outline-slate-200"
          cdkDropList
          #sprintList="cdkDropList"
          [cdkDropListData]="done"
          [cdkDropListConnectedTo]="[backlogList]"
          (cdkDropListDropped)="drop($event)"
          role="list"
          aria-label="Lista do sprint ativo"
        >
          @if (done.length === 0) {
            <div class="text-xs text-gray-500 py-3 px-3">
              Arraste itens para iniciar o sprint
            </div>
          }
          @for (item of done; track item.id) {
            <div
              class="card-tasks"
              cdkDrag
              [cdkDragData]="item"
              role="listitem"
              tabindex="0"
            >
              {{ item.titulo }}
            </div>
          }
        </div>
      </div>
    </div>
  }

  <app-flyingcards-configure-modal
    (cancel)="closeConfigModal()"
    [open]="openConfigure"
    [sprints]="sprints"
    [activeSprint]="activeSprint"
    (confirm)="onCreateOrUpdateSprint($event)"
    (delete)="onDeleteSprint($event)"
    (selectSprint)="onSelectSprint($event)"
  >
  </app-flyingcards-configure-modal>
</div>
